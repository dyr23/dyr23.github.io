<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èšä¼šæ‘‡éª°å­ - DYR23</title>
    <style>
        body {
            background-color: #F8BBD0; 
            font-family: "Microsoft YaHei", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
        }

        h1 {
            color: #880E4F;
            font-size: 24px;
            margin-bottom: 20px;
        }

        #dice-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 90%;
            max-width: 400px;
            min-height: 200px;
            align-items: center;
        }

        .die {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: grid;
            grid-template: repeat(3, 1fr) / repeat(3, 1fr);
            padding: 4px;
            box-sizing: border-box;
            transition: transform 0.3s;
        }

        .dot {
            background-color: #D81B60;
            border-radius: 50%;
            width: 10px;
            height: 10px;
            margin: auto;
            display: block;
        }

        .controls {
            margin-top: 40px;
            text-align: center;
            width: 100%;
        }

        .btn {
            background-color: #E91E63;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 30px;
            box-shadow: 0 4px 0 #880E4F;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
        }
        .btn:active {
            box-shadow: none;
            transform: translateY(4px);
        }

        select {
            padding: 10px;
            font-size: 18px;
            border-radius: 10px;
            border: 2px solid #E91E63;
            background: white;
            color: #E91E63;
            outline: none;
        }

        .back-link {
            margin-top: 20px;
            color: #880E4F;
            text-decoration: none;
            font-size: 14px;
        }
        
        /* çŠ¶æ€æç¤ºä¿¡æ¯ */
        #status-msg {
            color: #880E4F;
            font-size: 12px;
            margin-top: 10px;
            opacity: 0.7;
        }

        @keyframes shake {
            0% { transform: rotate(0deg) translate(0, 0); }
            25% { transform: rotate(15deg) translate(5px, 5px); }
            50% { transform: rotate(-15deg) translate(-5px, -5px); }
            75% { transform: rotate(5deg) translate(5px, -5px); }
            100% { transform: rotate(0deg) translate(0, 0); }
        }
        .shaking {
            animation: shake 0.3s infinite;
        }
    </style>
</head>
<body>

    <h1>ğŸ² ç”©åŠ¨æ‰‹æœºæ‘‡éª°å­</h1>

    <div id="dice-container"></div>

    <div class="controls">
        <label style="color:#880E4F; font-weight:bold;">éª°å­æ•°é‡ï¼š</label>
        <select id="dice-count" onchange="createDice()">
            <option value="1">1ä¸ª</option>
            <option value="2">2ä¸ª</option>
            <option value="3">3ä¸ª</option>
            <option value="4">4ä¸ª</option>
            <option value="5" selected>5ä¸ª</option>
            <option value="6">6ä¸ª</option>
        </select>
        <br><br>
        <button class="btn" onclick="checkPermissionAndRoll()">æ‰‹åŠ¨æ‘‡ä¸€æ‘‡</button>
        <div id="status-msg">è‹¹æœæ‰‹æœºè¯·å…ˆæ‰‹åŠ¨ç‚¹ä¸€æ¬¡æŒ‰é’®å¼€å¯æ„Ÿåº”</div>
    </div>

    <br>
    <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>

    <script>
        const faceConfig = {
            1: [4],
            2: [0, 8],
            3: [0, 4, 8],
            4: [0, 2, 6, 8],
            5: [0, 2, 4, 6, 8],
            6: [0, 2, 3, 5, 6, 8]
        };

        const container = document.getElementById('dice-container');
        const countSelect = document.getElementById('dice-count');
        let isRolling = false; // é˜²æ­¢æ‘‡å¤ªå¿«é‡å¤è§¦å‘
        let shakeThreshold = 25; // æ‘‡åŠ¨çµæ•åº¦ï¼Œè¶Šå°è¶Šçµæ•
        let lastX = 0, lastY = 0, lastZ = 0;
        let lastUpdate = 0;

        // åˆå§‹åŒ–
        createDice();
        initShakeEvent(); // å°è¯•åˆå§‹åŒ–ï¼ˆé’ˆå¯¹å®‰å“ï¼‰

        function createDice() {
            container.innerHTML = '';
            const count = countSelect.value;
            for (let i = 0; i < count; i++) {
                let die = document.createElement('div');
                die.className = 'die';
                drawDots(die, 1);
                container.appendChild(die);
            }
        }

        function drawDots(dieElement, number) {
            dieElement.innerHTML = '';
            const positions = faceConfig[number];
            for (let i = 0; i < 9; i++) {
                let cell = document.createElement('div');
                if (positions.includes(i)) {
                    let dot = document.createElement('div');
                    dot.className = 'dot';
                    if (number === 1) {
                        dot.style.width = '16px';
                        dot.style.height = '16px';
                        dot.style.backgroundColor = 'red';
                    }
                    cell.appendChild(dot);
                }
                dieElement.appendChild(cell);
            }
        }

        // å¤„ç†è‹¹æœiOS 13+çš„æƒé™é—®é¢˜
        function checkPermissionAndRoll() {
            // å¦‚æœå·²ç»åœ¨æ‘‡äº†ï¼Œå°±ä¸ç®¡
            if (isRolling) return;

            // 1. æ­£å¸¸çš„ç‚¹å‡»æ‘‡éª°å­é€»è¾‘
            rollDice();

            // 2. é¡ºä¾¿ç”³è¯·ä¸€ä¸‹æ‘‡ä¸€æ‘‡æƒé™ï¼ˆåªé’ˆå¯¹iOSï¼‰
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('devicemotion', handleShake);
                            document.getElementById('status-msg').innerText = "æ„Ÿåº”å·²å¼€å¯ï¼Œç”¨åŠ›ç”©æ‰‹æœºå§ï¼";
                        }
                    })
                    .catch(console.error);
            }
        }

        // å®‰å“è®¾å¤‡é€šå¸¸ä¸éœ€è¦ç”³è¯·ï¼Œç›´æ¥ç›‘å¬
        function initShakeEvent() {
            if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission !== 'function') {
                window.addEventListener('devicemotion', handleShake);
                document.getElementById('status-msg').innerText = "æ„Ÿåº”å·²è‡ªåŠ¨å¼€å¯";
            }
        }

        // ç›‘å¬æ‘‡åŠ¨äº‹ä»¶çš„æ ¸å¿ƒé€»è¾‘
        function handleShake(event) {
            if (isRolling) return; // æ­£åœ¨æ‘‡çš„æ—¶å€™ä¸è¦é‡å¤è§¦å‘

            let acceleration = event.accelerationIncludingGravity;
            let curTime = new Date().getTime();

            if ((curTime - lastUpdate) > 100) {
                let diffTime = curTime - lastUpdate;
                lastUpdate = curTime;

                let x = acceleration.x;
                let y = acceleration.y;
                let z = acceleration.z;

                let speed = Math.abs(x + y + z - lastX - lastY - lastZ) / diffTime * 10000;

                if (speed > shakeThreshold) {
                    rollDice();
                }

                lastX = x;
                lastY = y;
                lastZ = z;
            }
        }

        // æ‰§è¡Œæ‘‡éª°å­åŠ¨ç”»
        function rollDice() {
            if (isRolling) return;
            isRolling = true;

            // æ‰‹æœºéœ‡åŠ¨åé¦ˆ (å¦‚æœè®¾å¤‡æ”¯æŒ)
            if (navigator.vibrate) {
                navigator.vibrate(200); 
            }

            const dice = document.querySelectorAll('.die');
            const btn = document.querySelector('.btn');
            
            btn.disabled = true;
            btn.innerText = "æ‘‡åŠ¨ä¸­...";
            
            dice.forEach(die => {
                die.classList.add('shaking');
                let interval = setInterval(() => {
                    drawDots(die, Math.floor(Math.random() * 6) + 1);
                }, 100);
                die.dataset.timer = interval;
            });

            setTimeout(() => {
                dice.forEach(die => {
                    clearInterval(die.dataset.timer);
                    die.classList.remove('shaking');
                    const finalNum = Math.floor(Math.random() * 6) + 1;
                    drawDots(die, finalNum);
                });
                btn.disabled = false;
                btn.innerText = "æ‰‹åŠ¨æ‘‡ä¸€æ‘‡";
                isRolling = false;
            }, 800);
        }
    </script>
</body>
</html>
